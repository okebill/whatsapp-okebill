<%- include('partials/header') %>

<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">Dashboard WhatsApp API Gateway</h4>
        </div>
        <div class="card-body">
          <% if (error) { %>
            <div class="alert alert-danger">
              <%= error %>
            </div>
          <% } %>

          <div class="row">
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header">
                  Status Koneksi
                </div>
                <div class="card-body">
                  <% if (whatsappStatus) { %>
                    <div class="alert alert-success mb-0">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                          <% if (profilePicture) { %>
                            <div class="me-3">
                              <img id="profilePicture" 
                                   src="<%= profilePicture %>" 
                                   alt="Profile Picture" 
                                   class="rounded-circle" 
                                   style="width: 50px; height: 50px; object-fit: cover;"
                                   onerror="this.style.display='none'">
                            </div>
                          <% } %>
                          <div>
                            <strong>Terhubung!</strong> WhatsApp sudah terhubung dan siap digunakan.
                            <% if (connectedNumber) { %>
                              <br><small class="text-muted">Nomor: <%= connectedNumber %></small>
                            <% } %>
                          </div>
                        </div>
                        <div>
                          <button id="refreshProfileBtn" 
                                  class="btn btn-outline-success btn-sm" 
                                  onclick="refreshProfile()"
                                  title="Refresh foto profil">
                            <i class="fas fa-sync-alt"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  <% } else { %>
                    <div class="alert alert-warning mb-0">
                      <strong>Belum terhubung!</strong> Silakan scan QR code untuk menghubungkan WhatsApp.
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header">
                  Informasi User
                </div>
                <div class="card-body">
                  <p><strong>Username:</strong> <%= user.username %></p>
                  <p><strong>Role:</strong> <%= user.role %></p>
                  <% if (connectedNumber) { %>
                    <p><strong>WhatsApp:</strong> <code><%= connectedNumber %></code></p>
                  <% } else if (whatsappStatus) { %>
                    <p><strong>WhatsApp:</strong> <span class="text-warning">Nomor tidak terdeteksi</span></p>
                  <% } else { %>
                    <p><strong>WhatsApp:</strong> <span class="text-muted">Belum terhubung</span></p>
                  <% } %>
                  <p class="mb-0"><strong>Status:</strong> <span class="badge bg-success">Online</span></p>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header">
                  Menu Cepat
                </div>
                <div class="card-body">
                  <div class="d-grid gap-2">
                    <a href="/dashboard/groups" class="btn btn-outline-info">Lihat Daftar Grup</a>
                    <a href="/dashboard/api-docs" class="btn btn-outline-warning">Dokumentasi API</a>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header">
                  Statistik Grup
                </div>
                <div class="card-body">
                  <% if (groups && groups.length > 0) { %>
                    <p><strong>Total Grup:</strong> <%= groups.length %></p>
                    <p class="mb-0"><strong>Total Peserta:</strong> <%= groups.reduce((sum, group) => sum + group.participants, 0) %></p>
                  <% } else { %>
                    <p class="mb-0">Tidak ada grup yang tersedia</p>
                  <% } %>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header">
                  Dokumentasi API
                </div>
                <div class="card-body">
                  <p>Gunakan endpoint berikut untuk berinteraksi dengan API:</p>
                  
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-light">
                        <tr>
                          <th>Endpoint</th>
                          <th>Method</th>
                          <th>Deskripsi</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td><code>/api/whatsapp/status</code></td>
                          <td>GET</td>
                          <td>Mendapatkan status koneksi WhatsApp - <em>Login required</em></td>
                        </tr>
                        <tr>
                          <td><code>/api/whatsapp/groups</code></td>
                          <td>GET</td>
                          <td>Mendapatkan daftar grup - <em>Login required</em></td>
                        </tr>
                        <tr>
                          <td><code>/api/whatsapp/send-message</code></td>
                          <td>POST</td>
                          <td>
                            Mengirim pesan ke nomor - <em>Login required</em><br>
                            <small>Body: <code>{ "number": "628xxxx", "message": "Hello world" }</code></small>
                          </td>
                        </tr>
                        <tr class="table-warning">
                          <td><code>/api/public/send-message</code></td>
                          <td>GET/POST</td>
                          <td>
                            <strong>API Publik:</strong> Mengirim pesan dengan API key<br>
                            <small>Parameter: <code>api_key, number, message</code></small>
                          </td>
                        </tr>
                        <tr class="table-warning">
                          <td><code>/api/public/status</code></td>
                          <td>GET</td>
                          <td>
                            <strong>API Publik:</strong> Status koneksi dengan API key<br>
                            <small>Parameter: <code>api_key</code></small>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script>
  // Fungsi untuk refresh foto profil
  function refreshProfile() {
    const btn = document.getElementById('refreshProfileBtn');
    const icon = btn.querySelector('i');
    
    // Tampilkan loading
    btn.disabled = true;
    icon.classList.add('fa-spin');
    
    fetch('/dashboard/refresh-profile', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success && data.profilePicture) {
        // Update foto profil
        const profileImg = document.getElementById('profilePicture');
        if (profileImg) {
          profileImg.src = data.profilePicture + '?t=' + Date.now(); // Cache busting
        }
        
        // Tampilkan pesan sukses
        showAlert('success', data.message || 'Foto profil berhasil diperbarui');
      } else {
        showAlert('warning', data.message || 'Tidak ada foto profil baru');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showAlert('danger', 'Terjadi kesalahan saat memperbarui foto profil');
    })
    .finally(() => {
      // Sembunyikan loading
      btn.disabled = false;
      icon.classList.remove('fa-spin');
    });
  }
  
  // Fungsi untuk menampilkan alert
  function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Tambahkan ke container
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto dismiss after 3 seconds
    setTimeout(() => {
      alertDiv.remove();
    }, 3000);
  }
</script>

</body>
</html> 