<%- include('partials/header') %>

<div class="container mt-4">
  <div class="row">
    <div class="col-md-10 mx-auto">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">Daftar Grup WhatsApp</h4>
        </div>
        <div class="card-body">
          <% if (!connected) { %>
            <div class="alert alert-warning mb-4">
              <strong>Peringatan!</strong> WhatsApp belum terhubung. Silakan <a href="/dashboard/scan" class="alert-link">scan QR code</a> terlebih dahulu.
            </div>
          <% } else if (groups && groups.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-light">
                  <tr>
                    <th>No</th>
                    <th>Nama Grup</th>
                    <th>ID Grup</th>
                    <th>Jumlah Anggota</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  <% groups.forEach((group, index) => { %>
                    <tr>
                      <td><%= index + 1 %></td>
                      <td><%= group.subject %></td>
                      <td><small class="text-muted"><%= group.id %></small></td>
                      <td><%= group.participants %> anggota</td>
                      <td>
                        <button class="btn btn-sm btn-primary send-btn" 
                                data-bs-toggle="modal" 
                                data-bs-target="#sendModal" 
                                data-id="<%= group.id %>" 
                                data-name="<%= group.subject %>">
                          Kirim Pesan
                        </button>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="alert alert-info">
              <strong>Info:</strong> Tidak ada grup ditemukan atau WhatsApp belum terhubung.
            </div>
          <% } %>
          
          <div class="mt-3">
            <a href="/dashboard" class="btn btn-secondary">Kembali ke Dashboard</a>
            <button id="refreshBtn" class="btn btn-info ms-2">Refresh Daftar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal untuk kirim pesan ke grup -->
<div class="modal fade" id="sendModal" tabindex="-1" aria-labelledby="sendModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sendModalLabel">Kirim Pesan ke Grup</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="sendGroupForm">
          <input type="hidden" id="groupId" name="groupId">
          <div class="mb-3">
            <label for="groupName" class="form-label">Nama Grup</label>
            <input type="text" class="form-control" id="groupName" readonly>
          </div>
          <div class="mb-3">
            <label for="groupMessage" class="form-label">Pesan</label>
            <textarea class="form-control" id="groupMessage" name="message" rows="4" required></textarea>
          </div>
          <div id="sendResult"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        <button type="button" class="btn btn-primary" id="sendGroupBtn">Kirim Pesan</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Fungsi refresh daftar grup
    document.getElementById('refreshBtn').addEventListener('click', function() {
      window.location.reload();
    });
    
    // Setup modal kirim pesan
    const sendModal = document.getElementById('sendModal');
    if (sendModal) {
      sendModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const groupId = button.getAttribute('data-id');
        const groupName = button.getAttribute('data-name');
        
        document.getElementById('groupId').value = groupId;
        document.getElementById('groupName').value = groupName;
      });
      
      // Handler kirim pesan ke grup
      document.getElementById('sendGroupBtn').addEventListener('click', function() {
        const groupId = document.getElementById('groupId').value;
        const message = document.getElementById('groupMessage').value;
        const resultDiv = document.getElementById('sendResult');
        
        if (!message) {
          resultDiv.innerHTML = '<div class="alert alert-danger mt-3">Pesan tidak boleh kosong</div>';
          return;
        }
        
        resultDiv.innerHTML = '<div class="alert alert-info mt-3">Mengirim pesan...</div>';
        
        fetch('/api/whatsapp/send-group-message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ groupId, message })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            resultDiv.innerHTML = '<div class="alert alert-success mt-3">Pesan berhasil dikirim!</div>';
          } else {
            resultDiv.innerHTML = `<div class="alert alert-danger mt-3">Gagal mengirim pesan: ${data.message}</div>`;
          }
        })
        .catch(error => {
          resultDiv.innerHTML = '<div class="alert alert-danger mt-3">Error: Gagal menghubungi server</div>';
          console.error('Error:', error);
        });
      });
    }
  });
</script>

<%- include('partials/footer') %> 