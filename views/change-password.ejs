<%- include('partials/header') %>

<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-key"></i> Ubah Password</h2>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item active">Ubah Password</li>
          </ol>
        </nav>
      </div>

      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-shield-alt"></i> Keamanan Akun</h5>
            </div>
            <div class="card-body">
              <form id="changePasswordForm" method="POST" action="/auth/change-password">
                <div class="mb-3">
                  <label for="currentPassword" class="form-label">
                    <i class="fas fa-lock"></i> Password Saat Ini
                  </label>
                  <div class="input-group">
                    <input type="password" class="form-control" id="currentPassword" name="currentPassword" 
                           required placeholder="Masukkan password saat ini">
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('currentPassword')">
                      <i class="fas fa-eye" id="currentPasswordIcon"></i>
                    </button>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="newPassword" class="form-label">
                    <i class="fas fa-key"></i> Password Baru
                  </label>
                  <div class="input-group">
                    <input type="password" class="form-control" id="newPassword" name="newPassword" 
                           required placeholder="Masukkan password baru" minlength="6">
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('newPassword')">
                      <i class="fas fa-eye" id="newPasswordIcon"></i>
                    </button>
                  </div>
                  <div class="form-text">
                    <i class="fas fa-info-circle"></i> Password minimal 6 karakter
                  </div>
                </div>

                <div class="mb-3">
                  <label for="confirmPassword" class="form-label">
                    <i class="fas fa-check-circle"></i> Konfirmasi Password Baru
                  </label>
                  <div class="input-group">
                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" 
                           required placeholder="Konfirmasi password baru" minlength="6">
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirmPassword')">
                      <i class="fas fa-eye" id="confirmPasswordIcon"></i>
                    </button>
                  </div>
                  <div class="invalid-feedback" id="passwordMismatch">
                    Password konfirmasi tidak cocok
                  </div>
                </div>

                <!-- Password Strength Indicator -->
                <div class="mb-3">
                  <label class="form-label">Kekuatan Password:</label>
                  <div class="progress" style="height: 5px;">
                    <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                  </div>
                  <small class="text-muted" id="passwordStrengthText">Masukkan password baru</small>
                </div>

                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="fas fa-save"></i> Ubah Password
                  </button>
                  <a href="/dashboard" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Kembali ke Dashboard
                  </a>
                </div>
              </form>
            </div>
          </div>

          <!-- Security Tips -->
          <div class="card mt-4">
            <div class="card-header">
              <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Tips Keamanan</h6>
            </div>
            <div class="card-body">
              <ul class="list-unstyled mb-0">
                <li class="mb-2">
                  <i class="fas fa-check-circle text-success"></i>
                  Gunakan kombinasi huruf besar, kecil, angka, dan simbol
                </li>
                <li class="mb-2">
                  <i class="fas fa-check-circle text-success"></i>
                  Minimal 8 karakter untuk keamanan optimal
                </li>
                <li class="mb-2">
                  <i class="fas fa-check-circle text-success"></i>
                  Jangan gunakan informasi pribadi yang mudah ditebak
                </li>
                <li class="mb-0">
                  <i class="fas fa-check-circle text-success"></i>
                  Ubah password secara berkala untuk keamanan maksimal
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script>
// Toggle password visibility
function togglePassword(inputId) {
  const input = document.getElementById(inputId);
  const icon = document.getElementById(inputId + 'Icon');
  
  if (input.type === 'password') {
    input.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    input.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
}

// Password strength checker
function checkPasswordStrength(password) {
  let strength = 0;
  let text = '';
  let color = '';
  
  if (password.length >= 6) strength += 20;
  if (password.length >= 8) strength += 20;
  if (/[a-z]/.test(password)) strength += 20;
  if (/[A-Z]/.test(password)) strength += 20;
  if (/[0-9]/.test(password)) strength += 10;
  if (/[^A-Za-z0-9]/.test(password)) strength += 10;
  
  if (strength < 30) {
    text = 'Lemah';
    color = 'bg-danger';
  } else if (strength < 60) {
    text = 'Sedang';
    color = 'bg-warning';
  } else if (strength < 90) {
    text = 'Kuat';
    color = 'bg-info';
  } else {
    text = 'Sangat Kuat';
    color = 'bg-success';
  }
  
  return { strength, text, color };
}

// Form validation and submission
document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const submitBtn = document.getElementById('submitBtn');
  
  // Validate password confirmation
  if (newPassword !== confirmPassword) {
    document.getElementById('confirmPassword').classList.add('is-invalid');
    document.getElementById('passwordMismatch').style.display = 'block';
    showError('Password konfirmasi tidak cocok');
    return;
  } else {
    document.getElementById('confirmPassword').classList.remove('is-invalid');
    document.getElementById('passwordMismatch').style.display = 'none';
  }
  
  // Validate password length
  if (newPassword.length < 6) {
    showError('Password baru minimal 6 karakter');
    return;
  }
  
  // Check if new password is different from current
  if (currentPassword === newPassword) {
    showError('Password baru harus berbeda dengan password saat ini');
    return;
  }
  
  // Show loading
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengubah Password...';
  
  // Submit form
  fetch('/auth/change-password', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      currentPassword: currentPassword,
      newPassword: newPassword,
      confirmPassword: confirmPassword
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showSuccess(data.message);
      // Reset form
      document.getElementById('changePasswordForm').reset();
      // Redirect after 2 seconds
      setTimeout(() => {
        window.location.href = '/dashboard';
      }, 2000);
    } else {
      showError(data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showError('Terjadi kesalahan saat mengubah password');
  })
  .finally(() => {
    // Reset button
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-save"></i> Ubah Password';
  });
});

// Real-time password strength checking
document.getElementById('newPassword').addEventListener('input', function(e) {
  const password = e.target.value;
  const strengthBar = document.getElementById('passwordStrength');
  const strengthText = document.getElementById('passwordStrengthText');
  
  if (password.length === 0) {
    strengthBar.style.width = '0%';
    strengthBar.className = 'progress-bar';
    strengthText.textContent = 'Masukkan password baru';
    return;
  }
  
  const result = checkPasswordStrength(password);
  strengthBar.style.width = result.strength + '%';
  strengthBar.className = 'progress-bar ' + result.color;
  strengthText.textContent = result.text;
});

// Real-time password confirmation checking
document.getElementById('confirmPassword').addEventListener('input', function(e) {
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = e.target.value;
  
  if (confirmPassword.length === 0) {
    e.target.classList.remove('is-invalid', 'is-valid');
    return;
  }
  
  if (newPassword === confirmPassword) {
    e.target.classList.remove('is-invalid');
    e.target.classList.add('is-valid');
    document.getElementById('passwordMismatch').style.display = 'none';
  } else {
    e.target.classList.remove('is-valid');
    e.target.classList.add('is-invalid');
    document.getElementById('passwordMismatch').style.display = 'block';
  }
});
</script> 